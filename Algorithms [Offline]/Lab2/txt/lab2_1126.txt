Используем дерево отрезков для поиска максимума на подотрезке.